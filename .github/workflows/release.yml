name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v0.1.0)

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Get version from tag
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: pwsh
      
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build application
      run: dotnet build -c Release --no-restore
      
    - name: Publish self-contained
      run: dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false --output ./publish-selfcontained
      
    - name: Publish framework-dependent
      run: dotnet publish -c Release -r win-x64 --self-contained false -p:PublishSingleFile=false --output ./publish-framework
      
    - name: Create portable package
      run: |
        # åˆ›å»ºä¾¿æºç‰ˆç›®å½•
        New-Item -ItemType Directory -Path "TransInputMethod-Portable" -Force
        
        # å¤åˆ¶è‡ªåŒ…å«ç‰ˆæœ¬æ–‡ä»¶
        Copy-Item -Path "publish-selfcontained/*" -Destination "TransInputMethod-Portable/" -Recurse -Force
        
        # åˆ›å»ºè¯´æ˜æ–‡ä»¶
        @"
        TransInputMethod v${{ steps.get_version.outputs.VERSION }} - Portable Version
        ==========================================
        
        è¿™æ˜¯ TransInputMethod çš„ä¾¿æºç‰ˆï¼Œæ— éœ€å®‰è£…å³å¯ä½¿ç”¨ã€‚
        
        å¿«é€Ÿå¼€å§‹ï¼š
        1. åŒå‡»è¿è¡Œ TransInputMethod.exe
        2. åœ¨è®¾ç½®ä¸­é…ç½®æ‚¨çš„ API å¯†é’¥
        3. ä½¿ç”¨ Shift+Space æ‰“å¼€ç¿»è¯‘çª—å£
        4. ä½¿ç”¨ Ctrl+Enter è¿›è¡Œç¿»è¯‘æˆ–å¤åˆ¶
        
        ç³»ç»Ÿè¦æ±‚ï¼š
        - Windows 10/11
        - .NET 8.0 Runtimeï¼ˆå·²åŒ…å«åœ¨æ­¤åŒ…ä¸­ï¼‰
        
        æ›´å¤šä¿¡æ¯ï¼š
        é¡¹ç›®åœ°å€ï¼šhttps://github.com/maxazure/TransInputMethod
        
        Copyright (c) 2024 maxazure
        Licensed under MIT License
        "@ | Out-File -FilePath "TransInputMethod-Portable/README.txt" -Encoding UTF8
        
        # åˆ›å»ºå®‰è£…è„šæœ¬
        @'
        @echo off
        chcp 65001 >nul
        echo æ­£åœ¨è®¾ç½® TransInputMethod...
        echo.
        
        set CURRENT_DIR=%~dp0
        set TARGET_PATH=%CURRENT_DIR%TransInputMethod.exe
        
        if not exist "%TARGET_PATH%" (
            echo é”™è¯¯ï¼šæ‰¾ä¸åˆ° TransInputMethod.exe
            pause
            exit /b 1
        )
        
        echo åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼...
        set DESKTOP=%USERPROFILE%\Desktop
        powershell -Command "$ws = New-Object -ComObject WScript.Shell; $s = $ws.CreateShortcut('%DESKTOP%\TransInputMethod.lnk'); $s.TargetPath = '%TARGET_PATH%'; $s.WorkingDirectory = '%CURRENT_DIR%'; $s.Description = 'æ‚¬æµ®ç¿»è¯‘è¾“å…¥æ³•å·¥å…·'; $s.Save()"
        
        echo åˆ›å»ºå¼€å§‹èœå•å¿«æ·æ–¹å¼...
        set STARTMENU=%APPDATA%\Microsoft\Windows\Start Menu\Programs
        if not exist "%STARTMENU%\TransInputMethod" mkdir "%STARTMENU%\TransInputMethod"
        powershell -Command "$ws = New-Object -ComObject WScript.Shell; $s = $ws.CreateShortcut('%STARTMENU%\TransInputMethod\TransInputMethod.lnk'); $s.TargetPath = '%TARGET_PATH%'; $s.WorkingDirectory = '%CURRENT_DIR%'; $s.Description = 'æ‚¬æµ®ç¿»è¯‘è¾“å…¥æ³•å·¥å…·'; $s.Save()"
        
        echo.
        echo å®‰è£…å®Œæˆï¼æ‚¨ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿è¡Œ TransInputMethodï¼š
        echo - æ¡Œé¢å¿«æ·æ–¹å¼
        echo - å¼€å§‹èœå•
        echo - æˆ–ç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶å¤¹ä¸­çš„ TransInputMethod.exe
        echo.
        pause
        '@ | Out-File -FilePath "TransInputMethod-Portable/Setup.bat" -Encoding UTF8
        
        # åˆ›å»ºå¸è½½è„šæœ¬
        @'
        @echo off
        chcp 65001 >nul
        echo æ­£åœ¨ç§»é™¤ TransInputMethod å¿«æ·æ–¹å¼...
        echo.
        
        set DESKTOP=%USERPROFILE%\Desktop
        if exist "%DESKTOP%\TransInputMethod.lnk" (
            del "%DESKTOP%\TransInputMethod.lnk"
            echo å·²åˆ é™¤æ¡Œé¢å¿«æ·æ–¹å¼
        )
        
        set STARTMENU=%APPDATA%\Microsoft\Windows\Start Menu\Programs\TransInputMethod
        if exist "%STARTMENU%" (
            rmdir /s /q "%STARTMENU%"
            echo å·²åˆ é™¤å¼€å§‹èœå•å¿«æ·æ–¹å¼
        )
        
        echo.
        echo å¿«æ·æ–¹å¼å·²åˆ é™¤ã€‚
        echo å¦‚éœ€å®Œå…¨åˆ é™¤ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹ã€‚
        pause
        '@ | Out-File -FilePath "TransInputMethod-Portable/Uninstall.bat" -Encoding UTF8
      shell: pwsh
      
    - name: Create ZIP packages
      run: |
        # ä¾¿æºç‰ˆ ZIP
        Compress-Archive -Path "TransInputMethod-Portable/*" -DestinationPath "TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Portable.zip" -Force
        
        # ä¾èµ–æ¡†æ¶ç‰ˆæœ¬ ZIP  
        Compress-Archive -Path "publish-framework/*" -DestinationPath "TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Framework.zip" -Force
        
        # è·å–æ–‡ä»¶å¤§å°
        $portableSize = [math]::Round((Get-Item "TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Portable.zip").Length / 1MB, 2)
        $frameworkSize = [math]::Round((Get-Item "TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Framework.zip").Length / 1MB, 2)
        
        echo "PORTABLE_SIZE=$portableSize" >> $env:GITHUB_OUTPUT
        echo "FRAMEWORK_SIZE=$frameworkSize" >> $env:GITHUB_OUTPUT
      shell: pwsh
      id: create_packages
      
    - name: Generate checksums
      run: |
        # ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
        Get-FileHash "TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Portable.zip" -Algorithm SHA256 | ForEach-Object { "$($_.Hash.ToLower())  TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Portable.zip" } | Out-File -FilePath "checksums.txt" -Encoding UTF8
        Get-FileHash "TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Framework.zip" -Algorithm SHA256 | ForEach-Object { "$($_.Hash.ToLower())  TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Framework.zip" } | Out-File -FilePath "checksums.txt" -Append -Encoding UTF8
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: TransInputMethod v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## TransInputMethod v${{ steps.get_version.outputs.VERSION }}
          
          æ‚¬æµ®ç¿»è¯‘è¾“å…¥æ³•å·¥å…· - æ”¯æŒä¸­è‹±æ–‡äº’è¯‘çš„å…¨å±€æ‚¬æµ®çª—å£
          
          ### ğŸ¯ ä¸»è¦åŠŸèƒ½
          - ğŸš€ å…¨å±€å¿«æ·é”® `Shift+Space` å‘¼å‡ºç¿»è¯‘çª—å£
          - ğŸ¯ æ™ºèƒ½ä¸­è‹±æ–‡äº’è¯‘ï¼Œè‡ªåŠ¨è¯­è¨€æ£€æµ‹
          - ğŸ“‹ ä¸€é”®å¤åˆ¶ `Ctrl+Enter` ç›´æ¥å¤åˆ¶è¯‘æ–‡
          - ğŸ¨ æ— è¾¹æ¡†æµ®åŠ¨è®¾è®¡ï¼Œè·Ÿéšå…‰æ ‡ä½ç½®
          - ğŸ“š å¤šç§ç¿»è¯‘åœºæ™¯ï¼šITåŠå…¬å£è¯­ã€æ­£å¼ä¹¦é¢ã€ITæŠ€æœ¯äº¤æµ
          - ğŸ—ƒï¸ æœ¬åœ°ç¿»è¯‘å†å²è®°å½•ï¼Œæ”¯æŒæœç´¢åˆ†é¡µ
          - ğŸ”— æ”¯æŒå¤šä¸ªAIæœåŠ¡å•†ï¼šOpenAIã€DeepSeekã€Claudeç­‰
          - ğŸ” é…ç½®ä¿¡æ¯æœ¬åœ°AESåŠ å¯†å­˜å‚¨
          
          ### ğŸ“¦ ä¸‹è½½é€‰é¡¹
          
          | æ–‡ä»¶ | å¤§å° | è¯´æ˜ |
          |------|------|------|
          | `TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Portable.zip` | ~${{ steps.create_packages.outputs.PORTABLE_SIZE }}MB | **æ¨è** - ä¾¿æºç‰ˆï¼ŒåŒ…å«.NETè¿è¡Œæ—¶ï¼Œè§£å‹å³ç”¨ |
          | `TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Framework.zip` | ~${{ steps.create_packages.outputs.FRAMEWORK_SIZE }}MB | ä¾èµ–æ¡†æ¶ç‰ˆæœ¬ï¼Œéœ€è¦å®‰è£….NET 8.0 Runtime |
          | `checksums.txt` | - | SHA256æ ¡éªŒå’Œæ–‡ä»¶ |
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½ä¾¿æºç‰ˆZIPæ–‡ä»¶å¹¶è§£å‹
          2. è¿è¡Œ `Setup.bat` åˆ›å»ºå¿«æ·æ–¹å¼ï¼ˆå¯é€‰ï¼‰
          3. è¿è¡Œ `TransInputMethod.exe`
          4. åœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥
          5. æŒ‰ `Shift+Space` å¼€å§‹ä½¿ç”¨
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Windows 10/11
          - .NET 8.0 Runtimeï¼ˆä¾¿æºç‰ˆå·²åŒ…å«ï¼‰
          
          ### ğŸ”§ é¦–æ¬¡ä½¿ç”¨
          è¯·åœ¨è®¾ç½®ä¸­é…ç½®æ‚¨çš„APIæœåŠ¡å•†å’Œå¯†é’¥ï¼š
          - æ”¯æŒ OpenAI GPT ç³»åˆ—
          - æ”¯æŒ DeepSeek
          - æ”¯æŒ Claude
          - æ”¯æŒå…¶ä»–å…¼å®¹ OpenAI API çš„æœåŠ¡
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](https://github.com/maxazure/TransInputMethod/blob/main/changelogs/CHANGELOG.md)
        files: |
          TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Portable.zip
          TransInputMethod-v${{ steps.get_version.outputs.VERSION }}-Framework.zip
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}