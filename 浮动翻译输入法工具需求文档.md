## 1. 文档目的

明确“浮动翻译输入法工具”各模块功能、交互、性能和技术规范，指导后续设计与开发。

---

## 2. 概述

- **产品定位**：一款全局可呼出的、像输入法一样的浮动翻译窗体工具，无需切换应用，即可中⇄英互译并管理历史记录。
- **主要场景**：在任意窗口按下 `Shift+Enter` 呼出浮动窗，输入中/英文后按 `Ctrl+Enter` 翻译；若文本未变化，再次按 `Ctrl+Enter` 自动复制上次译文；历史记录可单独窗体分页查看并复制。
- **核心价值**：轻量、快捷、免切换；支持自定义模型 Key 和 Prompt；持久化翻译历史；基于 .NET 8 WinForms 实现。

---

## 3. 功能性需求

| 编号  | 功能           | 说明                                                                   |
| --- | ------------ | -------------------------------------------------------------------- |
| FR1 | **全局呼出快捷键**  | 利用 Windows 钩子监听系统级呼出快捷键（默认 `Shift+Enter`），可在“设置”窗体中自定义修改；触发浮动翻译窗体显示。 |
| FR2 | **翻译/复制快捷键** | 在浮动窗体中监听 `Ctrl+Enter`：                                               |

> - **首按**：检测语言并翻译，结果覆盖文本框，并持久化存储；
> - **二按**（文本未改变）：将上次译文复制至剪贴板。                     | | FR3  | **单一多行文本框**            | 窗体仅含一个可编辑多行文本框，兼作“输入”和“展示译文”。                           | | FR4  | **无装饰浮动窗体**            | 窗体无标题栏、无状态栏、无关闭按钮；下方左侧为【历史窗口】小图标按钮；下方中间为↑/↓箭头按钮，用于在当前窗体内切换历史原文+译文组合；右侧为语言风格下拉框，支持“生活”“书面”“科技”等选项，切换不同提示词。           | | FR5  | **自动高度伸缩**            | 文本框及窗体高度随内容行数自动扩展（上限为屏幕高度），宽度固定约 600px。             | | FR6  | **位置智能跟随**            | 浮动窗体初次出现时自动贴近当前鼠标指针或文本光标位置，避免遮挡输入区域。                | | FR7  | **本地翻译持久化**           | 每次翻译完成后，将 `{源文, 译文, 时间戳}` 写入本地 SQLite 数据库 `translations.db` 的 `history` 表。   | | FR8  | **历史记录窗体**            | 单独窗体展示历史记录，具有标准标题栏和关闭按钮。窗体内：
> - 按页展示多条 `原文：xxxx` / `译文：aaaa`，条目间以分隔线 `---------------` 分隔；
> - 支持分页导航（上一页/下一页）；
> - 鼠标悬停到任一记录时，在该记录右侧浮现“复制”按钮，点击可复制对应译文或原+译。  | **历史记录窗体**            | 单独窗体展示历史记录，具有标准标题栏和关闭按钮。窗体内：
> - 按页展示多条 `原文：xxxx` / `译文：aaaa`，条目间以分隔线 `---------------` 分隔；
> - 支持分页导航（上一页/下一页）；
> - 每条记录旁或右键菜单提供“复制”操作，将对应译文或原+译同时复制到剪贴板。  |

---

## 4. 非功能性需求

1. **性能**
   - UI 响应（打开/关闭/高度伸缩）< 50 ms；翻译接口响应 < 500 ms（网络延迟外）。
2. **可用性**
   - 浮动窗体支持深/浅色主题、自定义透明度；
   - 历史窗体及设置窗体采用标准窗体样式，支持系统窗口管理；
   - 快捷键冲突时提供自定义配置。
3. **安全性**
   - 翻译历史数据库存放于用户目录，使用明文 SQLite 文件，便于用户使用 sqlite 客户端打开和备份；
   - API Key 与 Prompt 在“设置”窗体中本地 AES 加密存储。
4. **可扩展性**
   - 模型调用封装抽象，支持未来新增其他大语言模型；
   - 数据访问层可替换为远程存储方案。
5. **稳定性**
   - SQLite 访问支持并发读写；
   - WinForms 异常处理保证主界面与历史窗体稳定。

---

## 5. 技术架构

- **前端（浮动 & 历史窗体、快捷键）**
  - **框架**：.NET 8 WinForms（C#）；
  - **全局快捷键**：使用 `SetWindowsHookEx` 实现对 `Shift+Enter`、`Ctrl+Enter` 的监听；
  - **浮动窗体**：`FormBorderStyle=None`，`TopMost=true`，宽度固定 600px，高度自适应；
  - **历史窗体**：标准 `FormBorderStyle=FixedDialog` 或 `Sizable`，包含标题栏、关闭按钮；
  - **复制操作**：使用 `Clipboard.SetText`。
- **后端（翻译调用）**
  - 直接在 WinForms 应用中通过 `HttpClient` 调用 LLM REST API；
  - 语言检测可由模型自动或本地简单判断实现。
- **数据存储**
  - 本地 SQLite 数据库（`translations.db`），表结构：
    ```sql
    CREATE TABLE history (  
      id INTEGER PRIMARY KEY AUTOINCREMENT,  
      source_text TEXT NOT NULL,  
      translated_text TEXT NOT NULL,  
      timestamp DATETIME DEFAULT CURRENT_TIMESTAMP  
    );  
    ```
  - 使用 `Microsoft.Data.Sqlite` 进行数据库操作；
- **配置持久化**
  - 存储文件：`config.json`（加密后存储 API Key 与 Prompt）；
  - 加密采用 `AesGcm`，密钥可使用 Windows DPAPI 自动管理。

---

## 6. 设置窗体需求

| 模块         | 说明                                                                               |   |                |
| ---------- | -------------------------------------------------------------------------------- | - | -------------- |
| 热键配置       | 呼出快捷键、翻译/复制快捷键输入框，支持用户自定义并持久化。                                                   |   |                |
| API Key 输入 | 单行输入框，支持明文/隐藏切换，本地 AES 加密存储并自动加载。                                                |   |                |
| 提示词场景管理    | 列表显示当前所有翻译场景（如“生活”“书面”“科技”等），每个场景对应一个 Prompt；支持新增场景、编辑场景名称及 Prompt、删除场景，变更后即时生效。 |   |                |
| 模型选择       | 下拉列表选择当前可用模型（如 GPT-4、GPT-3.5）。                                                   |   |                |
| 持久化与加载     | `[保存]`后写入加密配置；应用启动时自动加载生效。                                                       |   |                |
| 操作按钮       | `[保存]`、`[取消]`。                                                                   |   | `[保存]`、`[取消]`。 |

---

## 7. UI 文字版设计稿

### 7.1 浮动翻译窗体（默认）

```
+-----------------------+
  在此输入中/英文
  按 Ctrl+Enter 翻译
  （灰色占位文字）
  [⌚] [↑] [↓] [生活▼]
+-----------------------+
```

### 7.2 历史记录窗体（分页）

```
+----------------------------+
  翻译历史记录           [×]   

  原文：Hello          [复制]
  译文：你好
  ---------------
  原文：今天天气如何？ [复制]
  译文：How’s the weather?
  ---------------

  [上一页] [下一页]
+----------------------------+
```

\----------------------------+ 翻译历史记录    [×]    Page 1



### 7.3 设置窗体（分页）



+------------------------------------------------+ 设置    [×]

场景管理：

&#x20;[生活 ▼]  [新增] [删除]

提示词： 在此输入模板，用于当前选中场景的提示词。



热键配置:

快捷键： 呼出： [Shift+Enter]

翻译： [Ctrl+Enter]

API Key： [ sk-＊＊＊＊＊＊＊＊＊＊＊＊ ]

Model： [ GPT-4.1 mini ▼ ]

[保存]    [取消] +------------------------------------------------+
